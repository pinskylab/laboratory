---
title: "Digest Method"
output: html_notebook
params:
  first: E2968
  last: E3063
  num_samples: NA
  num_plate: NA
---
*Copy and paste this file into the lab-notebooks folder, changing the name to match the sample range you are currently working on.*  

**This protocol assumes that you have read and understand the manufacturer’s instructions attached below.  Please read the full manufacturer’s instructions before using this abbreviated protocol.**

```{r setup, include = FALSE}

# load libraries
library(tidyverse)
library(kableExtra)
library(knitr)

# load functions
source("~/db-connections.R")

# load data
lab <- read_db("Laboratory")
```


## Prep for digest
The most difficult part of the digest is figuring out where to put the samples.  In most cases, it is very straightforward.  You pull the sample from the extraction plate and place it in the same well on the digest plate.  For example, if an extract is in A4 of the extraction plate, run the digestion reaction in well A4 of the digest plate.  

If this is the case, the source plate map would look like this:
```{r}
need_digest <- lab %>% tbl("extraction") %>% collect() %>% 
  # hasn't been digested
  filter(extraction_id >= params$first & extraction_id <= params$last) %>% 
  # select columns
  select(extraction_id, well, plate, quant) %>% 
  # need enough material to work with
  filter(quant > 5) %>% 
  # sort by extraction id
  arrange(extraction_id) %>% 
  # create row and column ids from well
  mutate(row = substr(well, 1,1), 
         col = as.numeric(substr(well, 2,3))) %>% 
  select(row, col, extraction_id)

# define wells
plate <- data.frame(row = rep(LETTERS[1:8], 12), col = unlist(lapply(1:12, rep, 8))) %>% 
  mutate(extraction_id = ifelse(row == "D" & col == 2, "XXXX", NA), 
    extraction_id = ifelse(row == "E" & col == 8, "XXXX", extraction_id))

# if the plate is not full
x <- nrow(need_digest) + 2
if (x < 96) {
  plate <- plate %>% 
    slice(1:x)
}

# remove the non-blank wells from the plate table
plate <- anti_join(plate, need_digest, by = c("row", "col"))

# rejoin the samples into the plate with the blanks, resulting in a plate of defined wells for samples and blanks.
plate <- rbind(plate, need_digest) %>% 
  arrange(col, row)

platemap <- as.matrix(reshape2::acast(plate, plate$row ~ plate$col), value.var = plate$extraction)
knitr::kable(platemap, booktabs = T) %>% 
  # use scale_down to get map to fit within the bounds of the pdf
  kable_styling(latex_options = "scale_down")

 
```



However, sometimes we skip some samples that did not perform well, or we want to digest a bunch of extracts from random plates.  If it is not a simple plate to plate transfer, the source plate map would look like this:
```{r}
digested <- lab %>% tbl("digest") %>% collect()
# TODO: should filter this for successful digests

  need_digest <- lab %>% tbl("extraction") %>% collect() %>% 
  # hasn't been digested
  filter(!extraction_id %in% digested$extraction_id) %>% 
  # select columns
  select(extraction_id, well, plate, quant) %>% 
  # need enough material to work with
  filter(quant > 5) %>% 
  # needs to be in a plate
  filter(!is.na(plate)) %>% 
  # sort by extraction id
  arrange(extraction_id)
  
  # define wells
plate <- data.frame(row = rep(LETTERS[1:8], 12), col = unlist(lapply(1:12, rep, 8))) %>% 
  mutate(extraction_id = ifelse(row == "D" & col == 2, "XXXX", NA), 
    extraction_id = ifelse(row == "E" & col == 8, "XXXX", extraction_id))

# if the plate is not full
x <- nrow(need_digest) + 2
if (x < 96) {
  if(x < 48){
    plate <- plate %>% 
      slice(1:x-1)
  }else{
    plate <- plate %>% 
    slice(1:x)
  }
}

# move all of the non-blank wells into their own table
samples <- plate %>% 
  filter(is.na(extraction_id)) %>% 
  select(-extraction_id)

# remove the non-blank wells from the plate table
plate <- anti_join(plate, samples, by = c("row", "col"))

# join the work sample_ids to the sample table well definitions
samples <- cbind(samples, need_digest) %>% 
  select(row, col, extraction_id)

# rejoin the samples into the plate with the blanks, resulting in a plate of defined wells for samples and blanks.
plate <- rbind(plate, samples) %>% 
  arrange(col, row)

source_map <- as.matrix(reshape2::acast(plate, plate$row ~ plate$col), value.var = plate$extraction)
knitr::kable(source_map, booktabs = T) %>% 
  # use scale_down to get map to fit within the bounds of the pdf
  kable_styling(latex_options = "scale_down")
```

A digest id must be created for these samples.  **Only do this step once!**  It creates new digest_ids for the database.
The destination plate map would look like this:
```{r}
### ONLY DO THIS ONCE ###
dig_max <- lab %>% tbl("digest") %>% 
  summarise(last = max(digest_id, na.rm = T)) %>% 
  collect() %>% 
  mutate(last = as.numeric(substr(last, 2,5)))

x <- dig_max$last+1
y <- dig_max$last+nrow(plate)
id_range <- x:y

plate <- plate %>% 
  mutate(digest_id = paste0("D", id_range),
         well = paste(row, col, sep = ""), 
         enzymes = "PstI-MluCI",
         vol_in = 30,
         final_vol = 45)

plate_name <- plate %>% 
  summarise(first = min(digest_id), 
    last = max(digest_id, na.rm = T))

plate <- plate %>% 
  mutate(plate = paste(plate_name$first, plate_name$last, sep = "-")) %>% 
  select(row, col, digest_id)

dest_map <- as.matrix(reshape2::acast(plate, plate$row ~ plate$col), value.var = plate$digest_id)

knitr::kable(dest_map, booktabs = T) %>% 
  kable_styling()

```




Print out plate maps and highlight source maps for ease of loading.  Make sure to note any samples that are heavily concentrated and need to be diluted.

Prepare digest plate by loading 30uL of sample in to the plate.

For the October 2017 set of plates, I highlighted the 15uL samples on the maps in orange and the “hole-fillers” in pink, then any samples I could take with a multichannel with a blue line down the column.

To load, I first used a single channel pipet to fill in the 15uL samples, pulling the tips from the same location they were on the plate.  Then I filled in the water for the 15uL wells and change the pipet to 30uL to fill the blanks.
Then I added any 30uL “hole fillers” - again using the tips from the same location in the tip box.

At this point, any empty wells on the plate correspond to tips in the tip box.  I used the multichannel pipet to pick up the tips and held them up to the plate to make sure no tips were going into already filled wells, and no empty wells were being left empty.  Then I filled the rest of the plate.

Fill in the digest page of the PCR worksheet
(PCR worksheet

)  

* Make the master mix recipe in 15mL falcon tube:
    * split the master mix into 8 wells, use a multichannel pipet to pipet 20µL of master mix into each sample well. 
        * Do not add the master mix to all of the wells and then add the sample.  Because you are working with active enzymes, they should be the last things added to the master mix and the last step of plate preparation.
* Incubate PstI and MluCI at 37˚ - No benefit from incubating MluCI longer than one hour, PstI is active 2-4 hours, don’t need to heat kill digests

Clean the digests using 1.5x the volume of the digest (75µL) Ampure per sample. Put the plates on yellow lifts on the magnet so that the pellet is lower before you finish the alcohol steps.   Because these are in plates and it is difficult to get all of the elute out of the well, elute in 45µL of buffer and pull 40µL from the well to place in a new cleaned digest plate.  Update the database. - Ampure clean up protocol

Quantifiy - quant-it pico green - import the quantification results into the Sample_Data spreadsheet, Digests Page quant column.  For any sample with a negative quantification value, change the Ligated? column value to N/A (the rest should contain a formula that results in the value “FALSE”).  Also, add an “_F” to the extraction ID (not the digest ID) in the extraction ID column (example: PADE14_093E1516 becomes PADE14_093E1516_F).  This digest failed and so the sample should not reflect that a successful digest exits.










Samples have been:
Extracted - Extraction Qiagen DNeasy Protocol
Run Gel - Gels
Quantified - quant-it pico green

Prepare a digest plate map:
* In Sample_Data file, on the Extractions sheet, select all and hit the filter button
* filter for samples have FALSE in the Digested column, then filter by Species and year (samples with a TRUE in this column have a digest_ID associated with the extraction_ID.  Samples with N/A are samples that have been determined to be failed extractions).
* Copy the desired extraction IDs from extraction sheet to digest sheet - it is possible that some decision making is necessary at this point.  If there are more than 96 candidates to be digested, copy all of the possibilities over into the digest sheet - extraction_ID column
Digest_ID
Extraction_ID
date
sample_vol_in
sample_ng_in
enzymes
buffer

APCL14_560E1878






APCL14_513E1354






APCL14_519E1360






APCL14_521E1362






APCL14_109E0879





    * 
    * 
    * Fill in the sample_vol column on the digest sheet
Digest_ID
Extraction_ID
date
sample_vol_in
sample_ng_in
enzymes
buffer

APCL14_560E1878

30.0




APCL14_513E1354

30.0




APCL14_519E1360

30.0




APCL14_521E1362

30.0




APCL14_109E0879

30.0



    * 
    * 
    * Drag in the formula and Sort by sample_ng (largest to smallest)
Digest_ID
Extraction_ID
date
sample_vol_in
sample_ng_in
enzymes
buffer

APCL14_560E1878

30.0
4137



APCL14_513E1354

30.0
2412



APCL14_519E1360

30.0
2093



APCL14_521E1362

30.0
2055



APCL14_109E0879

30.0
1989


    * More decision making is necessary at this point.  If an extract has less than 5ng/ul DNA, it will most likely fail to digest well.  This is a tough call, some digests with much less than 5ng/ul have ligated successfully and others have not.  Proceed with caution. If there are plenty of samples to choose from, choose the desired number with the most “sample_ng_in”.
        * As of 8/19/2014 
            * any extraction less than 5ng/µL we are putting on the back burner to continue processing at a later date
            * anything that is more than 5ng/µL but makes less than 1µg of DNA when you multiply the quant result by 30µL (the digest addition amount) - calculate the amount of extract to make 1µg DNA and clean that amount, elute in 30µL and add to digest plate 
            * As of 11/2014 we are not worried about “too low” DNA and are not cleaning samples that are below 1000ng.  We have successfully digested down to 100ng.  
            * anything that makes more than 5µg of DNA when you multiply the quant result by 30µL - add 15µL of extract to plate and 15µL pH2O - do the math to make sure this dilution will still be less than 5µg.
    * For the time being, enter the ExtractID in the Digest ID column for ease of sorting (it is easiest to work on extract plates in sample order) - do this by entering the formula =right(B1882,5) in column A
    * Sort by Extract Id (no digest number yet, will sort by sample number), only the range of this plate!!!
    * Fill in date, enzyme, Digest# and replace the Extract# in the Digest_ID column with the formula to concatenate a digest ID.
    * print a map of your extraction plate and new digest plate
* highlight samples in printed extraction plate maps
* pipeted aliquot to digest plate for a 50µL digestion reaction
* Print a plate map and determine which samples can be digested as is, and which need to be diluted - highlight accordingly

Prepare digestion plate by adding 30µL of sample to each well according to the digest map prepared above.

Digestion recipe 50µL rxn - use digestion sheet in PCR worksheet, double check math:
(https://docs.google.com/spreadsheets/d/1LGt2WziwmGoJMluBcwmKfhZrGjZOlJLkVHf59-5cOV4/edit?usp=sharing)  
number of samples
10% error
reaction size
enzyme 1 original conc U/mL
enzyme 2 original conc
pipette master mix into each rxn:
# of units of each enzyme per 50uL rxn
96
106
50
20000
10000
20
20









µL sample
enzyme 1
enzyme 2
µL pH20
µL buffer

per sample
30
1
2
12
5







1,920
master mix

96
192
1,152
480







divide final master mix into 8 wells:
240






* Make the master mix recipe in 15mL falcon tube:
    * for the above example, combine:
        * 1152 µL pH2O
        * 480 µL digest buffer
        * 96 µL of enzyme 1
        * 192 µL of enzyme 2
    * split the master mix into 8 wells, use a multichannel pipet to pipet 20µL of master mix into each sample well. 
        * Do not add the master mix to all of the wells and then add the sample.  Because you are working with active enzymes, they should be the last things added to the master mix and the last step of plate preparation.
* Incubate PstI and MluCI at 37˚ - No benefit from incubating MluCI longer than one hour, PstI is active 2-4 hours, don’t need to heat kill digests

Clean the digests using 1.5x the volume of the digest (75µL) Ampure per sample. Put the plates on yellow lifts on the magnet so that the pellet is lower before you finish the alcohol steps.   Because these are in plates and it is difficult to get all of the elute out of the well, elute in 45µL of buffer and pull 40µL from the well to place in a new cleaned digest plate.  Record this volume of 40 on the Sample_Data spreadsheet, Digests Page in the buffer column - Ampure clean up protocol

Quantifiy - quant-it pico green - import the quantification results into the Sample_Data spreadsheet, Digests Page quant column.  For any sample with a negative quantification value, change the Ligated? column value to N/A (the rest should contain a formula that results in the value “FALSE”).  Also, add an “_F” to the extraction ID (not the digest ID) in the extraction ID column (example: PADE14_093E1516 becomes PADE14_093E1516_F).  This digest failed and so the sample should not reflect that a successful digest exits.

Next samples will be:
Cleaned - Ampure clean up protocol
Ligated and Pooled- Ligation
Cleaned 2X - Ampure clean up protocol
Pippin - Pippin Prep
PCR'd - PCR
Cleaned - Ampure clean up protocol
Quantified - Qubit Protocol
Prepared for sequencing - Preparing samples for sequencing

Optimizing Restriction Endonuclease Reactions | New England Biolabs
For a 50µL rxn, use:

1µg DNA - fill to volume w/ pH2O
5µL 10x buffer (50µL/10x=5)

Want a total of 10U in rxn
For single digest:
if enzyme is 10,000U/mL - 1µL = 10U
if enzyme is 20,000U/mL - 0.5µL = 10U

For double digest
if enzyme is 10,000U/mL - 0.5µL = 5U
if enzyme is 20,000U/mL - 0.25µL = 5U 

PstI - cutsite is  https://www.neb.com/products/r0140-psti

MluCI - cutsite is  https://www.neb.com/products/r0538-mluci

EcoRI cutsite is  https://www.neb.com/products/r0101-ecori
