---
title: "Create a budget for the protocol"
params: 
  num_rna_samples: 4
  num_dna_samples: 160
  num_pools: 1
  num_seq_lib: 1
  num_rna_lib: 1
  num_dna_adapters: 48
  num_rna_adapters: 4
---

# Before beginning this protocol, determine your desired sequencing fragment length.

MRS creates a budget by going through each step of the protocol and creating a supply list.  

These lists are read in here and the total numbers of supplies are summed.

These sums are compared against a list read in from the google doc "inventory".  This doc contains item names that match the names used in the supply list for easy merging.

```{r setup}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
options(scipen = 999)
library(tidyverse)
library(rmarkdown)
library(here)
library(googledrive)
library(googlesheets4)
```

# EecSeq Lab Protocol

### 1. RNA Extraction
```{r rna-extr}
render(here("protocols", "rna_extraction_tri.Rmd"), params = list(
  num_samples = params$num_rna_samples
))
```

	
### 2. Quantify all RNA samples
```{r quant1}
if(params$num_rna_samples >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
  plate1 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
  qubit1 <- qubit
  rm(qubit)
}
```


### 3. Visualize RNA on BioAnalyzer

```{r bioanalyzer1}
render(here("protocols", "bioanalyzer.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
bioanalyzer1 <- bioanalyzer
rm(bioanalyzer)
```

### 4. Anneal RNA Adapters
```{r anneal1}
render(here("protocols", "anneal.Rmd"), params = list(
  initial_conc_uM=100, 
  p1_adapter_name="sai_universal_stock_adapter_ul",
  p2_adapter_name="sai_indexed_stock_adapter_ul"), run_pandoc = F)
anneal <- anneal %>% 
  # make for 4 adapters
  mutate(quantity = quantity * params$num_rna_adapters)
anneal1 <- anneal
rm(anneal)

# make annealing stock for all 4 adapters
render(here("protocols", "annealing_stock.Rmd"), params = list(
  final_vol_ul = 15000), run_pandoc = F)
```
```{r working1}
# make working stock for all 4 adapters
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 40,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock = "sai_stock_adapter_ul"
),run_pandoc = F)
working1 <- working %>% 
  # make for 4 adapters
  mutate(quantity = quantity * params$num_rna_adapters)
rm(working)
```

### 5. mRNA Capture
```{r bead-wash}
render(here("protocols", "mrna-capture.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
```

### 6. Synthesis
```{r synthesis}
render(here("protocols", "synthesis_eecseq.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
```

### 7. Cleanup  
- instead of eluting in water or TE, elute in 15 ul A-Tailing buffer
```{r ampure1}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_samples, 
  sample_vol_ul = 30,
  ampure_vol_ul = 54), run_pandoc = F)
ampure1 <- ampure
rm(ampure)
```

### 8. A-Tailing
```{r a-tailing}
render(here("protocols", "a-tailing.Rmd"), params = list(
  num_samples = params$num_rna_samples,
  stopped = "yes"), run_pandoc = F)
```

### 9. RNA Adapter Ligation

```{r rna-ligation}
render(here("protocols", "rna_ligation_eecseq.Rmd"), params = list(num_samples = params$num_rna_samples), run_pandoc = F)
```


### 10 Post-Ligation Cleanup
```{r ampure2}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_samples, 
  sample_vol_ul = 35,
  ampure_vol_ul = 35), run_pandoc = F)
ampure2 <- ampure
rm(ampure)
```

### Safe Stopping Point
The solution with resuspended beads can be stored at 4 °C for up to 24 hours. Do not freeze the beads, as this can result in dramatic loss of DNA. When ready, proceed to --2nd Post-Ligation Cleanup--.

---

### 2nd Post-Ligation Cleanup
```{r ampure3}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_samples, 
  sample_vol_ul = 25,
  ampure_vol_ul = 25), run_pandoc = F)
ampure3 <- ampure
rm(ampure)
```


### SAFE STOPPING POINT
The purified, adapter-ligated library DNA may be stored at 4 °C for up to 1 week, or frozen at -20 °C for up to 1 month. When ready, proceed to --Library Amplification--.

---
### 12. RNA Library Amplificiation

```{r rna-amp}
render(here("protocols", "rna_amp_eecseq.Rmd"), params = list(
  num_samples = params$num_rna_samples
), run_pandoc = F)
```


### 13 Library Amplification Cleanup
```{r ampure4}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_samples, 
  sample_vol_ul = 25,
  ampure_vol_ul = 25), run_pandoc = F)
ampure4 <- ampure
rm(ampure)
```

## 14. Quant libraries
```{r quant2}
if(params$num_rna_samples >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
  plate2 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_rna_samples), run_pandoc = F)
  qubit2 <- qubit
  rm(qubit)
}
```

---

### Safe Stopping Point
This is a safe stopping point. If you are stopping, store your sample at ‐15° to ‐25°C.

---


### 15. DSN Normalization
```{r dsn}
render(here("protocols", "dsn-norm.Rmd"), params = list(
    num_rna = params$num_rna_samples,
  num_lib = params$num_rna_lib
), run_pandoc = F)

# may need to make 5M NaCl solution
render(here("protocols", "nacl_stock.Rmd"), params = list(
    final_conc_M = 5,
  final_vol_l = 0.050), run_pandoc = F)
```

### 16. Cleanup
```{r ampure5}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_lib, 
  sample_vol_ul = 80,
  ampure_vol_ul = 160), run_pandoc = F)
ampure5 <- ampure
rm(ampure)
```

### DSN PCR
```{r dsn-pcr}
render(here("protocols", "dsn-pcr.Rmd"), params = list(
  num_samples = params$num_rna_lib), run_pandoc = F)
```


### Cleanup
```{r ampure6}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_lib, 
  sample_vol_ul = 50,
  ampure_vol_ul = 80), run_pandoc = F)
ampure6 <- ampure
rm(ampure)
```

### Quant
```{r quant3}
if(params$num_rna_lib >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_rna_lib), run_pandoc = F)
  plate3 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_rna_lib), run_pandoc = F)
  qubit3 <- qubit
  rm(qubit)
}
```


## Probe Synthesis


### Remove adapters from cDNA
```{r remove-adapters}
render(here("protocols", "remove-adapters_eecseq.Rmd"), run_pandoc = F)
```




### Bioanalyzer or trace
```{r bioanalyzer2}
render(here("protocols", "bioanalyzer.Rmd"), params = list(
  num_samples = params$num_seq_lib), run_pandoc = F)
bioanalyzer2 <- bioanalyzer
rm(bioanalyzer)
```


### Perform a 1.8X SPRI cleanup by combining the following:
```{r ampure7}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_lib, 
  sample_vol_ul = 45,
  ampure_vol_ul = 81), run_pandoc = F)
ampure7 <- ampure
rm(ampure)
```



### Perform a 1.5X SPRI cleanup by combining the following:
```{r ampure8}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_lib, 
  sample_vol_ul = 22,
  ampure_vol_ul = 33), run_pandoc = F)
ampure8 <- ampure
rm(ampure)
```

### Safe Stopping Point
This is a safe stopping point. If you are stopping, store your sample at ‐15° to ‐25°C.

---

### Biotin Labeling
```{r biotin}
render(here("protocols", "biotin_eecseq.Rmd"), run_pandoc = F)
```


###  Perform a 1.5X SPRI® cleanup by combining the following:
```{r ampure9}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_rna_lib, 
  sample_vol_ul = 50,
  ampure_vol_ul = 75), run_pandoc = F)
ampure9 <- ampure
rm(ampure)
```


### Quant Probes
```{r quant4}
if(params$num_rna_lib >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_rna_lib), run_pandoc = F)
  plate4 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_rna_lib), run_pandoc = F)
  qubit4 <- qubit
  rm(qubit)
}
```


### Visualize Probes

- Run probes on BioAnalyzer/Tape Station/Fragment analyzer 
```{r bioanalyzer3}
render(here("protocols", "bioanalyzer.Rmd"), params = list(
  num_samples = params$num_seq_lib), run_pandoc = F)
bioanalyzer3 <- bioanalyzer
rm(bioanalyzer)
```


### Safe Stopping Point
This is a safe stopping point. If you are stopping, store your sample at ‐15° to ‐25°C.



# Preparation of whole genome libraries 

### Anneal Adapters
```{r anneal2}
render(here("protocols", "anneal.Rmd"), params = list(
    initial_conc_uM = 100,
  p1_adapter_name = "p1_barcoded_adapter_1_ul",
  p2_adapter_name = "p1_barcoded_adapter_2_ul"), run_pandoc = F)
anneal2 <- anneal %>% 
    mutate(quantity = quantity * params$num_dna_adapters)
rm(anneal)
```
```{r anneal3}
render(here("protocols", "anneal.Rmd"), params = list(
    initial_conc_uM = 100,
  p1_adapter_name = "p2_barcoded_adapter_1_ul",
  p2_adapter_name = "p2_barcoded_adapter_2_ul"), run_pandoc = F)
anneal3 <- anneal 
rm(anneal)
```
```{r working2}
# the following makes the working adapters
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 40,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock="p1_stock_adapter_ul"
),run_pandoc = F)

working2 <- working %>% 
  # make for all adapters
  mutate(quantity = quantity * params$num_dna_adapters)
rm(working)
```
```{r working3}
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 40,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock="p2_stock_adapter_ul"
),run_pandoc = F)

working3 <- working 
rm(working)
```

### Extract DNA
```{r extract-dna}
render(here("protocols", "dna_extraction_ali.Rmd"), params = list(
  num_samples = params$num_dna_samples
), run_pandoc = F)

# might need to make liftons
render(here("protocols", "liftons_stock.Rmd"), run_pandoc = F)

# might need to make liftons with enzyme
render(here("protocols", "liftons_w_enzyme_stock.Rmd"), run_pandoc = F)
```

### Fragment DNA
If not using a sonicator, skip End Repair section and instead do a digest
```{r digest-dna}
render(here("protocols", "digest_dna.Rmd"),params = list(
  digest_rxn_size = 30,
  num_samples = params$num_dna_samples), run_pandoc = F)
```


### Procedure

### End repair
- Adjust sample volume of 500 ng fragmented DNA to 22.5 ul.
- Add the following to each sample:

|Component|Volume|
|---------|------|
|KAPA Frag Buffer (10X) | 2.5|
|End Repair & A-Tailing Buffer- | 3.5 ul|
|End Repair & A-Tailing Enzyme Mix- | 1.5 ul|
|Fragmented, double-stranded DNA| 25 ul |
|--Total Volume--| --30 ul--|

  - The buffer and enzyme mix should preferably be pre-mixed and added in a single pipetting step. 
    - Premixes are stable for ≤24 hrs at room temperature, for ≤3 days at 4°C, and for ≤4 weeks at -20°C
  - Vortex gently and spin down briefly. Return the reaction plate/tube(s) to ice. Proceed immediately to the next step.
  - Incubate in a thermocycler programmed as outlined below. A heated lid is required for this step. If possible, set the temperature of the heated lid to ~85°C (instead of the usual 105°C).

|Step|Temp|Time|
|----|----|--------|
|End repair and A-tailing 1|20 °C|30 min|
|End repair and A-tailing 2|65 °C|30 min|
|Hold|10 °C | ∞|

- Notes
  - A heated lid is required for this incubation. If possible, set the temperature of the lid at 85°C, instead of the usual ~105°C.
  - If proceeding to the adapter ligation reaction setup without any delay, the reaction may be cooled to 20°C instead of 4°C.

### Adapter ligation
```{r ligate-dna}
 render(here("protocols", "ligation_eecseq.Rmd"), params = list(
  num_samples = params$num_dna_samples), run_pandoc = F)
```


### Post-ligation Cleanup
```{r kapa-clean}
 render(here("protocols", "kapa-clean.Rmd"), params = list(
  sample_vol_ul = 55,
  bead_vol_ul = 44, 
  num_samples = params$num_dna_samples), run_pandoc = F)
```

### Quant samples
```{r quant5}
if(params$num_dna_samples >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_dna_samples), run_pandoc = F)
  plate5 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_dna_samples), run_pandoc = F)
  qubit5 <- qubit
  rm(qubit)
}
```



### Pool samples to be used with in the same index/capture.  
```{r pool}
render(here("protocols", "pool.Rmd"), params = list(
  num_samples_in = params$num_dna_samples, 
  num_pools_out = params$num_seq_lib
))
```


### Library Amplification

```{r amp}
render(here("protocols", "lib-amp_eecseq.Rmd"), params = list(
  num_seq_lib = params$num_seq_lib))
```
```{r working4}
# make working stock of primers
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 200,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock= "f_p1_primer_universal_stock_ul"
),run_pandoc = F)
working4 <- working
rm(working)
```
```{r working5}

render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 200,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock= "r_p2_primer_illumina_index_stock_ul"
),run_pandoc = F)

working5 <- working
rm(working)

```


### Post-amplification Cleanup
- Resuspend in 15 ul of 10 mM Tris or water
```{r ampure10}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_seq_lib, 
  sample_vol_ul = 25,
  ampure_vol_ul = 25))
ampure10 <- ampure
rm(ampure)
```


---

### Safe Stopping Point
This is a safe stopping point. If you are stopping, store your sample at ‐15° to ‐25°C.

---
## Hybridization and Capture

### Hybridization

```{r hybrid}

render(here("protocols", "hybridization_eecseq.Rmd"), params = list(
  lib_size_ng = 500, 
  num_seq_lib = 1))

# may need to make 500mM EDTA stock solution - 50mL
render(here("protocols", "edta_stock.Rmd"), params = list(
  final_conc_M = 0.500,
  final_vol_l = 0.050))

# may need to make 10% SDS stock solution - 50mL
render(here("protocols", "sds_stock.Rmd"), params = list(
  final_conc_perc = 10,
  final_vol_ml = 50))

# may need to make TEN stock solution - 50 ml
render(here("protocols", "ten_stock.Rmd"), params = list(
 final_vol_ul = 50000))

# may need to make various SSC / 0.1% SDS stock solution - 50 ml
render(here("protocols", "ssc_sds_stock_eecseq.Rmd"), params = list(
 final_vol_ul = 500, 
 perc_ssc = 1))
wash1 <- wash
rm(wash)

render(here("protocols", "ssc_sds_stock_eecseq.Rmd"), params = list(
 final_vol_ul = 500, 
 perc_ssc = 0.5))
wash2 <- wash
rm(wash)

render(here("protocols", "ssc_sds_stock_eecseq.Rmd"), params = list(
 final_vol_ul = 500, 
 perc_ssc = 0.1))
wash3 <- wash
rm(wash)
```
					

### Library re-amplification
```{r reamp}
render(here("protocols", "lib-reamp_eecseq.Rmd"), params = list(
  num_seq_lib = params$num_seq_lib), run_pandoc = F)
```

```{r working6}
# make working stock of primers
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 200,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock="f_p1_primer_universal_stock_ul"
),run_pandoc = F)
working6 <- working
rm(working)

```
```{r working7}
render(here("protocols", "adapter_working_stock.Rmd"), params = list(
  initial_conc_uM = 200,
  working_conc_uM = 10, 
  final_vol_ul = 100, 
  adpater_stock="r_p2_primer_illumina_index_stock_ul"
),run_pandoc = F)

working7 <- working
rm(working)
```

### Perform a 1X SPRI® cleanup by combining the following:
```{r ampure11}
render(here("protocols", "ampure.Rmd"), params = list(
  num_samples = params$num_seq_lib, 
  sample_vol_ul = 25,
  ampure_vol_ul = 25))
ampure11 <- ampure
rm(ampure)

# may need to make 10mM pH 8 Tris-HCl stock solution - 50mL
render(here("protocols", "tris-hcl_stock.Rmd"), params = list(
  final_conc_M = 0.010,
  pH = 8.0,
  final_vol_l = 0.050,
  mol_wt = 121.1))
```


### Quant samples
```{r quant6}
if(params$num_dna_samples >= 20){
  render(here("protocols", "plate-reader.Rmd"), params = list(
  num_samples = params$num_dna_samples), run_pandoc = F)
  plate6 <- plate
  rm(plate)
}else{
  render(here("protocols", "Qubit-HS.Rmd"), params = list(
  num_samples = params$num_dna_samples), run_pandoc = F)
  qubit6 <- qubit
  rm(qubit)
}
```

### Verify  
- Run samples on BioAnalyzer/Tape Station/Fragment analyzer  
- check with Nicole Wagner in Debashish's lab for current pricing.  This assumes you are using a High Sensitivity chip (max 7kb per library).
```{r bioanalyzer4}
render(here("protocols", "bioanalyzer.Rmd"), params = list(
  num_samples = params$num_seq_lib), run_pandoc = F)
bioanalyzer4 <- bioanalyzer
```
### Sequencing
```{r sequencing}
seq <- tribble(~item, ~quantity,
               "sequencing_lane", params$num_seq_lib)
```


# Combine the lists
```{r combine}
all_lists <- bind_rows(a_tailing, amp, ampure1, ampure2, ampure3, ampure4, ampure5, ampure6, ampure7, ampure8, ampure9, ampure10, ampure11,  anneal1, anneal2, anneal3, annealing, bioanalyzer1, bioanalyzer2, bioanalyzer3, bioanalyzer4, biotin, clean, digest_dna, dsn_norm, dsn_pcr, dyna, edta, enzyme, extr, hybrid, kapa_clean, liftons, ligation, mrna_capture, nacl, plate5, plate6, pool, qubit1, qubit2, qubit3, qubit4, reamp, remove, rna_amp, rna_extr, rna_ligation, sds, synthesis, TEN, tris_hcl, wash3, wash1, wash2, working1, working2, working3, working4, working5, working6, working7, seq)

all_sum <- all_lists %>% 
  group_by(item) %>% 
  summarise(quantity = ceiling(sum(quantity))) %>% 
  # adjust the size of the ampure purchase if needed
  mutate(item = ifelse(item == "ampure_ul", 
                       ifelse(quantity > 60000, "ampure_450", "ampure_60"),item))%>% 
  arrange()
```

# Merge with inventory costs
```{r inventory}
# enter code here to look up inventory on google drive
inventory_file <- googledrive::drive_get("~/Pinsky Lab Orders/Inventory")
sheets_deauth()
inventory_raw <- read_sheet(inventory_file, sheet = "Inventory", col_types = "c????n???n????")

supplies <- left_join(all_sum, inventory_raw, by = "item") %>% 
  select(item, quantity, currently_have, vendor, item_number, quantity_sold, price) %>% 
  mutate(cost_per_unit = price/quantity_sold,
         cost_per_project = cost_per_unit * quantity) %>% 
  arrange(price) %>% 
  select(price, vendor, everything())
```

### Total project cost 
```{r}
project_cost <- supplies %>% 
  summarise(cost = sum(price, na.rm = T))

cost_per_sample <- project_cost %>% 
  mutate(cost = cost/(params$num_rna_samples + params$num_dna_samples))
```

### What do we really need to purchase
```{r}
to_buy <- supplies %>% 
  filter(quantity >= currently_have) %>% 
  filter(price != 0)

cost_to_buy <- to_buy %>% 
  summarise(cost = sum(price, na.rm = T))
```

